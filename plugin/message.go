package plugin

import (
	"fmt"
	ent "github.com/catalystsquad/protoc-gen-go-ent/options"
	"github.com/iancoleman/strcase"
	"google.golang.org/protobuf/compiler/protogen"
	"google.golang.org/protobuf/proto"
)

func HandleProtoMessage(gen *protogen.Plugin, file *protogen.File, message *protogen.Message) error {
	if shouldHandleMessage(message) {
		g := createFile(gen, file, message)
		writeFileHeader(g, file, message)
		writeImports(g, message)
		writeStruct(g, message)
		WriteFields(g, message)
		WriteAnnotations(g, message)
		err := WriteEdges(g, message)
		if err != nil {
			return err
		}
	}

	return nil
}

func shouldHandleMessage(message *protogen.Message) bool {
	messageOptions := getMessageOptions(message)
	return messageOptions.Gen
}

func createFile(gen *protogen.Plugin, file *protogen.File, message *protogen.Message) *protogen.GeneratedFile {
	fileName := getMessageFileName(file, message)
	importPath := getMessageFileImportPath(file)
	g := gen.NewGeneratedFile(fileName, importPath)
	return g
}

func getMessageFileName(file *protogen.File, message *protogen.Message) string {
	messageName := getMessageGoName(message)
	return fmt.Sprintf("example/ent/ent/schema/%s_%s_ent.pb.go", file.GeneratedFilenamePrefix, strcase.ToSnake(messageName))
}

func getMessageFileImportPath(file *protogen.File) protogen.GoImportPath {
	return ""
}

func getMessageGoName(message *protogen.Message) string {
	return message.GoIdent.GoName
}

func getMessageProtoName(message *protogen.Message) string {
	return string(message.Desc.Name())
}

func writeFileHeader(g *protogen.GeneratedFile, file *protogen.File, message *protogen.Message) {
	packageName := getMessageFilePackageName(file)
	g.P("// Code generated by protoc-gen-go-ent. DO NOT EDIT.")
	g.P()
	g.P("package ", packageName)
	g.P()
}

func getMessageFilePackageName(file *protogen.File) string {
	return "schema"
}

func writeImports(g *protogen.GeneratedFile, message *protogen.Message) {
	g.QualifiedGoIdent(protogen.GoIdent{GoImportPath: "entgo.io/ent"})
	g.QualifiedGoIdent(protogen.GoIdent{GoImportPath: "entgo.io/contrib/entgql"})
	g.QualifiedGoIdent(protogen.GoIdent{GoImportPath: "entgo.io/ent/schema"})
	messageOptions := getMessageOptions(message)
	for _, additonalImport := range messageOptions.AdditionalImports {
		g.QualifiedGoIdent(protogen.GoIdent{GoImportPath: protogen.GoImportPath(additonalImport)})
	}
}

func writeStruct(g *protogen.GeneratedFile, message *protogen.Message) {
	structName := getMessageStructName(message)
	g.P(fmt.Sprintf("type %s struct {", structName))
	g.P("  ent.Schema")
	g.P("}")
}

func getMessageStructName(message *protogen.Message) string {
	return getMessageGoName(message)
}

func getMessageOptions(message *protogen.Message) ent.EntMessageOptions {
	options := message.Desc.Options()
	if options == nil {
		return ent.EntMessageOptions{}
	}
	v := proto.GetExtension(options, ent.E_Opts)
	if v == nil {
		return ent.EntMessageOptions{}
	}

	opts, ok := v.(*ent.EntMessageOptions)
	if !ok || opts == nil {
		return ent.EntMessageOptions{}
	}
	return *opts
}

func getMessageField(name string, message *protogen.Message) *protogen.Field {
	for _, field := range message.Fields {
		if getFieldProtoName(field) == name {
			return field
		}
	}

	return nil
}
